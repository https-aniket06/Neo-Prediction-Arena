<!DOCTYPE html>

<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>StockPredict AI Playground</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#66ffdb",
                        "background-light": "#f5f8f8",
                        "background-dark": "#0f231e",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(102, 255, 219, 0.1);
        }

        .ai-glow {
            box-shadow: 0 0 20px rgba(102, 255, 219, 0.15);
        }

        .candlestick-green {
            fill: #66ffdb;
            stroke: #66ffdb;
        }

        .candlestick-red {
            fill: #ff6685;
            stroke: #ff6685;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 font-display min-h-screen">
    <!-- Top Navigation -->
    <header
        class="flex items-center justify-between border-b border-primary/10 px-8 py-4 bg-background-light dark:bg-background-dark sticky top-0 z-50">
        <div class="flex items-center gap-8">
            <a href="home.html" class="flex items-center gap-3 text-primary hover:opacity-80 transition-opacity">
                <span class="material-symbols-outlined text-3xl">insights</span>
                <h2 class="text-slate-900 dark:text-slate-100 text-xl font-bold tracking-tight">Predictor<span
                        class="text-primary">Playground</span></h2>
            </a>
            <nav class="hidden md:flex items-center gap-6">
                <a class="text-primary text-sm font-semibold border-b-2 border-primary pb-1" href="#">Live Arena</a>

            </nav>
        </div>
        <div class="flex items-center gap-6">
            <div class="hidden sm:flex items-center bg-primary/10 px-3 py-1.5 rounded-lg border border-primary/20">
                <span class="material-symbols-outlined text-primary text-sm mr-2">account_balance_wallet</span>
                <span class="text-xs font-bold text-primary">$42,500.00</span>
            </div>
            <div class="size-10 rounded-full border-2 border-primary/30 p-0.5">
                <div class="w-full h-full rounded-full bg-cover bg-center" data-alt="User profile avatar circle"
                    style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBppmr_gS7hQTcRU11NUYFT6G-sD_0iMsAnhjdvG67rq-NIPNqXsBNPK73CNRpoJli7LXESx4_8qEW4JMfUMFpKX94nkMDMQ5XMYval3owsVTVKZyH225EdTQx8s0_4ziM08wYbXmKQ2rNPfaJtNzPLiSRFzDQjZRV9NsDdXsSglEyGDoua43h0LVgD0S92cFK46yzX6koeUVA28MOGOgoXpiNKEW7QAxjV6AWe6LexTpW6Daind-phxunciCsC6sLN2bJNtxIl5TzO')">
                </div>
            </div>
        </div>
    </header>
    <main class="flex flex-col lg:flex-row h-[calc(100vh-73px)] overflow-hidden">
        <!-- Sidebar: Assets & Controls -->
        <aside
            class="w-full lg:w-80 border-r border-primary/10 bg-background-light dark:bg-background-dark/50 overflow-y-auto p-6 flex flex-col gap-8">
            <!-- Asset Selector -->
            <div>
                <h3 class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-4">Select Asset</h3>
                <div class="space-y-2">
                    <button onclick="switchAsset('BTC')" id="asset-btn-BTC"
                        class="w-full flex items-center justify-between p-3 rounded-xl bg-primary/20 border border-primary/40 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-primary">currency_bitcoin</span>
                            <div class="text-left">
                                <div class="text-sm font-bold">BTC/USD</div>
                                <div class="text-[10px] text-primary/70">Bitcoin</div>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-primary" id="asset-change-BTC">...</span>
                    </button>
                    <button onclick="switchAsset('NVDA')" id="asset-btn-NVDA"
                        class="w-full flex items-center justify-between p-3 rounded-xl border border-primary/5 hover:bg-primary/5 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-slate-400">monetization_on</span>
                            <div class="text-left">
                                <div class="text-sm font-bold">NVDA</div>
                                <div class="text-[10px] text-slate-500">NVIDIA Corp.</div>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-slate-400" id="asset-change-NVDA">...</span>
                    </button>
                </div>
            </div>
            <!-- AI Status Visualization -->
            <div class="glass-panel rounded-2xl p-5 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-symbols-outlined text-primary text-lg animate-pulse">psychology</span>
                        <h3 class="text-xs font-bold uppercase tracking-widest text-primary">AI Neural Engine</h3>
                    </div>
                    <div class="flex flex-col gap-3">
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Data Processing</span>
                            <span class="text-primary font-mono">98.2%</span>
                        </div>
                        <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-primary ai-glow" style="width: 98%"></div>
                        </div>
                        <p class="text-[10px] text-slate-500 italic mt-2">Processing 4.2M sentiment points/sec...</p>
                    </div>
                </div>
            </div>
            <!-- Control Pad -->
            <div class="mt-auto space-y-6">
                <div class="space-y-3">
                    <label class="text-xs font-bold uppercase tracking-widest text-slate-400">Prediction
                        Direction</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="dir-bullish" onclick="selectDirection('BULLISH')"
                            class="flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-primary bg-primary/10 text-primary">
                            <span class="material-symbols-outlined text-3xl">trending_up</span>
                            <span class="text-xs font-bold">BULLISH</span>
                        </button>
                        <button id="dir-bearish" onclick="selectDirection('BEARISH')"
                            class="flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-slate-700 hover:border-red-500/50 hover:bg-red-500/10 transition-all text-slate-400 hover:text-red-500">
                            <span class="material-symbols-outlined text-3xl">trending_down</span>
                            <span class="text-xs font-bold">BEARISH</span>
                        </button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold uppercase tracking-widest text-slate-400">Position Size</label>
                        <span id="pos-size-label" class="text-xs font-bold text-primary">$1,250.00</span>
                    </div>
                    <input id="position-slider" min="100" max="10000" step="50" value="1250"
                        oninput="document.getElementById('pos-size-label').textContent = '$' + Number(this.value).toLocaleString('en-US', {minimumFractionDigits: 2})"
                        class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-primary"
                        type="range" />
                </div>
                <button id="submit-prediction-btn" onclick="submitPrediction()"
                    class="w-full py-4 bg-primary text-background-dark font-bold rounded-xl shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all">
                    SUBMIT PREDICTION
                </button>
            </div>
        </aside>
        <!-- Main Chart Area -->
        <section class="flex-1 flex flex-col relative">
            <!-- Chart Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-primary/10">
                <div class="flex items-center gap-6">
                    <div>
                        <div id="main-price-display" class="text-2xl font-bold">...</div>
                        <div id="main-change-display" class="text-xs text-primary font-medium">...</div>
                    </div>
                    <div class="h-8 w-px bg-primary/10"></div>
                    <div class="flex gap-2">
                        <span class="px-2 py-1 rounded bg-slate-800 text-[10px] font-bold">1H</span>
                        <span class="px-2 py-1 rounded bg-primary/20 text-primary text-[10px] font-bold">4H</span>
                        <span class="px-2 py-1 rounded bg-slate-800 text-[10px] font-bold">1D</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span
                        class="material-symbols-outlined text-slate-400 cursor-pointer hover:text-primary transition-colors"
                        onclick="showGlobalNotifications()">notifications</span>
                    <span
                        class="material-symbols-outlined text-slate-400 cursor-pointer hover:text-primary transition-colors"
                        onclick="showGlobalSettings()">settings</span>
                    <span onclick="alert('Entering Fullscreen Mode...')"
                        class="material-symbols-outlined text-slate-400 cursor-pointer hover:text-primary transition-colors">fullscreen</span>
                </div>
            </div>
            <!-- 3D Candlestick Container -->
            <div class="flex-1 relative bg-background-light dark:bg-background-dark/30 p-8">
                <!-- Grid Lines -->
                <div class="absolute inset-0 pointer-events-none opacity-20"
                    style="background-image: linear-gradient(to right, #66ffdb 1px, transparent 1px), linear-gradient(to bottom, #66ffdb 1px, transparent 1px); background-size: 80px 80px;">
                </div>
                <div class="w-full h-full relative flex items-center justify-center">
                    <!-- SVG Mockup of 3D-styled Candles -->
                    <svg class="w-full h-full" viewbox="0 0 800 400">
                        <!-- Candles -->
                        <g class="candlesticks">
                            <!-- Candle 1 -->
                            <line stroke="#ff6685" stroke-width="2" x1="100" x2="100" y1="200" y2="280"></line>
                            <rect class="candlestick-red" height="40" rx="2" width="16" x="92" y="220"></rect>
                            <!-- Candle 2 -->
                            <line stroke="#66ffdb" stroke-width="2" x1="150" x2="150" y1="180" y2="260"></line>
                            <rect class="candlestick-green" height="50" rx="2" width="16" x="142" y="190"></rect>
                            <!-- Candle 3 -->
                            <line stroke="#66ffdb" stroke-width="2" x1="200" x2="200" y1="160" y2="240"></line>
                            <rect class="candlestick-green" height="30" rx="2" width="16" x="192" y="170"></rect>
                            <!-- Candle 4 -->
                            <line stroke="#ff6685" stroke-width="2" x1="250" x2="250" y1="140" y2="220"></line>
                            <rect class="candlestick-red" height="60" rx="2" width="16" x="242" y="150"></rect>
                            <!-- Active Price Line -->
                            <line stroke="#66ffdb" stroke-dasharray="4" stroke-width="1" x1="0" x2="800" y1="180"
                                y2="180"></line>
                            <rect fill="#66ffdb" height="20" rx="4" width="60" x="740" y="170"></rect>
                            <text fill="#0f231e" font-size="10" font-weight="bold" x="745" y="184">64,281</text>
                        </g>
                        <!-- Prediction Ghost Curves -->
                        <path d="M250 180 Q 400 100 600 150" fill="none" opacity="0.6" stroke="#66ffdb"
                            stroke-dasharray="8" stroke-width="3"></path>
                        <path d="M250 180 Q 400 250 600 280" fill="none" opacity="0.4" stroke="#ff6685"
                            stroke-dasharray="8" stroke-width="2"></path>
                    </svg>
                    <!-- Prediction UI Overlay -->
                    <div
                        class="absolute bottom-12 left-1/2 -translate-x-1/2 flex items-center gap-8 glass-panel p-6 rounded-3xl ai-glow">
                        <div class="flex flex-col items-center">
                            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter mb-2">AI Logic
                                Node</div>
                            <div
                                class="size-16 rounded-full border-4 border-primary/20 flex items-center justify-center relative">
                                <span class="material-symbols-outlined text-primary text-2xl">neurology</span>
                                <div class="absolute inset-0 border-4 border-primary rounded-full"
                                    style="clip-path: inset(0 0 15% 0);"></div>
                            </div>
                        </div>
                        <div class="h-10 w-px bg-primary/20"></div>
                        <div class="text-center">
                            <div class="text-xs text-slate-400 font-medium">Confidence Score</div>
                            <div class="text-4xl font-black text-primary tracking-tighter">84.2%</div>
                        </div>
                        <div class="h-10 w-px bg-primary/20"></div>
                        <div class="flex flex-col">
                            <div class="text-[10px] font-bold text-slate-500 uppercase mb-1">Sentiment Scan</div>
                            <div class="flex gap-1">
                                <div class="w-1 h-4 bg-primary rounded-full"></div>
                                <div class="w-1 h-6 bg-primary rounded-full"></div>
                                <div class="w-1 h-4 bg-primary rounded-full"></div>
                                <div class="w-1 h-8 bg-primary rounded-full"></div>
                                <div class="w-1 h-3 bg-primary/20 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Comparison Split Footer -->
            <div class="h-48 border-t border-primary/10 flex">
                <div class="flex-1 border-r border-primary/10 p-6 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <h4 class="text-xs font-bold uppercase text-slate-500">Your Prediction</h4>
                        <span
                            class="text-[10px] px-2 py-0.5 rounded bg-blue-500/20 text-blue-400 font-bold uppercase">Manual</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="user-pred-icon"
                            class="material-symbols-outlined text-3xl text-slate-500">query_stats</span>
                        <div>
                            <div id="user-pred-text" class="text-lg font-bold text-slate-500">No Prediction</div>
                            <div id="user-pred-target" class="text-xs text-slate-600">Enter a prediction above</div>
                        </div>
                    </div>
                    <div class="w-full h-1 bg-slate-800 rounded-full">
                        <div id="user-pred-bar" class="h-full bg-slate-600" style="width: 0%"></div>
                    </div>
                </div>
                <div class="flex-1 p-6 flex flex-col justify-between bg-primary/5">
                    <div class="flex justify-between items-start">
                        <h4 class="text-xs font-bold uppercase text-primary">AI Prediction</h4>
                        <span
                            class="text-[10px] px-2 py-0.5 rounded bg-primary text-background-dark font-bold uppercase">Optimized</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="ai-pred-icon"
                            class="material-symbols-outlined text-3xl text-primary">trending_up</span>
                        <div>
                            <div id="ai-pred-text" class="text-lg font-bold text-primary">...</div>
                            <div id="ai-pred-target" class="text-xs text-primary/70">...</div>
                        </div>
                    </div>
                    <div class="w-full h-1 bg-primary/20 rounded-full">
                        <div id="ai-pred-bar" class="h-full bg-primary" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Right: Social / Feed -->
        <aside
            class="hidden xl:flex w-80 border-l border-primary/10 bg-background-light dark:bg-background-dark/50 flex-col">
            <div class="p-6 border-b border-primary/10">
                <h3 class="text-xs font-bold uppercase tracking-widest text-slate-400">Live Insights</h3>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="glass-panel p-4 rounded-xl border-l-4 border-l-primary">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="size-6 rounded-full bg-primary/20 flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary text-xs">bolt</span>
                        </div>
                        <span class="text-xs font-bold text-primary">Neural Spike</span>
                    </div>
                    <p class="text-xs text-slate-300 leading-relaxed">Whale activity detected on Binance. Prediction
                        confidence increasing.</p>
                </div>
                <div class="glass-panel p-4 rounded-xl">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="size-6 rounded-full bg-slate-800 flex items-center justify-center">
                            <span class="material-symbols-outlined text-slate-400 text-xs">public</span>
                        </div>
                        <span class="text-xs font-bold">Macro Event</span>
                    </div>
                    <p class="text-xs text-slate-400 leading-relaxed">FOMC meeting minutes released. Volatility expected
                        in 14 minutes.</p>
                </div>
                <!-- AI Brain visualization processing -->
                <div class="mt-8 flex flex-col items-center">
                    <div class="relative size-40">
                        <div
                            class="absolute inset-0 rounded-full border-2 border-primary/10 animate-[spin_10s_linear_infinite]">
                        </div>
                        <div
                            class="absolute inset-4 rounded-full border-2 border-primary/20 border-dashed animate-[spin_15s_linear_infinite_reverse]">
                        </div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span
                                class="material-symbols-outlined text-5xl text-primary opacity-50 ai-glow">biotech</span>
                        </div>
                    </div>
                    <div class="mt-4 flex flex-col items-center gap-1">
                        <div class="flex gap-1">
                            <span class="size-1 bg-primary rounded-full animate-bounce"></span>
                            <span class="size-1 bg-primary rounded-full animate-bounce [animation-delay:0.2s]"></span>
                            <span class="size-1 bg-primary rounded-full animate-bounce [animation-delay:0.4s]"></span>
                        </div>
                        <span class="text-[10px] text-primary/50 font-mono">NEURAL_SYNC_ACTIVE</span>
                    </div>
                </div>
            </div>
        </aside>
    </main>
    <script src="neo-api.js"></script>
    <script>
        if (!requireAuth()) throw 'Not authenticated';

        let selectedSymbol = 'BTC'; // Default load BTC

        async function switchAsset(symbol) {
            selectedSymbol = symbol;

            // Update active states on buttons
            const btcBtn = document.getElementById('asset-btn-BTC');
            const nvdaBtn = document.getElementById('asset-btn-NVDA');

            if (symbol === 'BTC') {
                btcBtn.className = 'w-full flex items-center justify-between p-3 rounded-xl bg-primary/20 border border-primary/40 transition-colors';
                nvdaBtn.className = 'w-full flex items-center justify-between p-3 rounded-xl border border-primary/5 hover:bg-primary/5 transition-colors';
            } else {
                nvdaBtn.className = 'w-full flex items-center justify-between p-3 rounded-xl bg-primary/20 border border-primary/40 transition-colors';
                btcBtn.className = 'w-full flex items-center justify-between p-3 rounded-xl border border-primary/5 hover:bg-primary/5 transition-colors';
            }

            // Reset predictions
            document.getElementById('user-pred-icon').className = 'material-symbols-outlined text-3xl text-slate-500';
            document.getElementById('user-pred-icon').textContent = 'query_stats';
            document.getElementById('user-pred-text').className = 'text-lg font-bold text-slate-500';
            document.getElementById('user-pred-text').textContent = 'No Prediction';
            document.getElementById('user-pred-target').textContent = 'Enter a prediction above';
            document.getElementById('user-pred-bar').className = 'h-full bg-slate-600';
            document.getElementById('user-pred-bar').style.width = '0%';

            await loadLiveTrading();
        }

        async function loadLiveTrading() {
            // Fetch live quote
            try {
                const quote = await apiGet('/trading/assets/' + selectedSymbol + '/quote');
                if (quote) {
                    const priceEl = document.getElementById('main-price-display');
                    if (priceEl) priceEl.textContent = '$' + Number(quote.price || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });

                    const changeEl = document.getElementById('main-change-display');
                    if (changeEl) {
                        const change = (quote.change || 0).toFixed(2);
                        const changePct = (quote.change_pct || 0).toFixed(2);
                        changeEl.textContent = `${change >= 0 ? '+' : ''}$${change} (${changePct}%)`;
                        changeEl.className = `text-xs font-medium ${change >= 0 ? 'text-primary' : 'text-red-400'}`;
                    }

                    const sideItemChange = document.getElementById('asset-change-' + selectedSymbol);
                    if (sideItemChange) {
                        const changePct = (quote.change_pct || 0).toFixed(2);
                        sideItemChange.textContent = `${changePct >= 0 ? '+' : ''}${changePct}%`;
                        sideItemChange.className = `text-xs font-bold ${changePct >= 0 ? 'text-primary' : 'text-red-400'}`;
                    }

                    // Update SVG price label
                    const priceLabel = document.querySelector('text[fill="#0f231e"]');
                    if (priceLabel) priceLabel.textContent = Number(quote.price || 0).toLocaleString();
                }
            } catch (e) { console.error('Error fetching quote', e); }

            // Fetch AI prediction
            try {
                const pred = await apiGet('/trading/assets/' + selectedSymbol + '/ai-prediction');
                if (pred) {
                    const confEl = document.querySelector('.text-4xl.font-black.text-primary');
                    if (confEl) confEl.textContent = pred.confidence + '%';

                    // Update AI prediction section in the bottom comparison
                    const aiDirEl = document.getElementById('ai-pred-text');
                    if (aiDirEl) {
                        const isBullish = pred.direction === 'BULLISH';
                        aiDirEl.textContent = pred.direction + ' ' + (isBullish || pred.predicted_change_pct >= 0 ? '+' : '') + pred.predicted_change_pct + '%';
                        aiDirEl.className = `text-lg font-bold ${isBullish ? 'text-primary' : 'text-red-500'}`;
                    }

                    const aiTargetEl = document.getElementById('ai-pred-target');
                    const quote = await apiGet('/trading/assets/' + selectedSymbol + '/quote');
                    if (aiTargetEl && quote) {
                        const price = quote.price || (selectedSymbol === 'BTC' ? 64000 : 800);
                        const targetPrice = price * (1 + (pred.predicted_change_pct / 100));
                        aiTargetEl.textContent = 'Target: $' + targetPrice.toLocaleString('en-US', { minimumFractionDigits: 2 });
                        aiTargetEl.className = `text-xs ${pred.direction === 'BULLISH' ? 'text-primary/70' : 'text-red-500/70'}`;
                    }

                    const aiBar = document.getElementById('ai-pred-bar');
                    if (aiBar) {
                        aiBar.style.width = pred.confidence + '%';
                        aiBar.className = `h-full ${pred.direction === 'BULLISH' ? 'bg-primary' : 'bg-red-500'}`;
                        aiBar.parentElement.className = `w-full h-1 ${pred.direction === 'BULLISH' ? 'bg-primary/20' : 'bg-red-500/20'} rounded-full`;
                    }

                    const aiIcon = document.getElementById('ai-pred-icon');
                    if (aiIcon) {
                        aiIcon.textContent = pred.direction === 'BULLISH' ? 'trending_up' : 'trending_down';
                        aiIcon.className = `material-symbols-outlined text-3xl ${pred.direction === 'BULLISH' ? 'text-primary' : 'text-red-500'}`;
                    }
                }
            } catch (e) { console.error('Error fetching prediction', e); }

            // Fetch balance
            const dash = await apiGet('/dashboard/summary');
            if (dash) {
                const balEl = document.querySelector('.text-xs.font-bold.text-primary');
                if (balEl && balEl.textContent.includes('$')) balEl.textContent = '$' + Number(dash.available_balance || 42500).toLocaleString('en-US', { minimumFractionDigits: 2 });
            }

            // Fetch market news for Live Insights
            const news = await apiGet('/market/news');
            if (news?.data) {
                const insightsContainer = document.querySelector('.overflow-y-auto.p-4.space-y-4');
                if (insightsContainer) {
                    insightsContainer.innerHTML = '';
                    news.data.slice(0, 4).forEach((n, i) => {
                        const isAlert = i === 0;
                        insightsContainer.innerHTML += `
          <div class="glass-panel p-4 rounded-xl ${isAlert ? 'border-l-4 border-l-primary' : ''}">
            <div class="flex items-center gap-2 mb-2">
              <div class="size-6 rounded-full ${isAlert ? 'bg-primary/20' : 'bg-slate-800'} flex items-center justify-center">
                <span class="material-symbols-outlined ${isAlert ? 'text-primary' : 'text-slate-400'} text-xs">${isAlert ? 'bolt' : 'public'}</span>
              </div>
              <span class="text-xs font-bold ${isAlert ? 'text-primary' : ''}">${n.source}</span>
            </div>
            <p class="text-xs text-slate-300 leading-relaxed">${n.headline}</p>
          </div>`;
                    });
                }
            }

            // Real-time Drastic Event Alert System (News Intelligence Module)
            if (!window.alertsInitialized) {
                setupDrasticEventAlerts();
                window.alertsInitialized = true;
            }
        }

        function setupDrasticEventAlerts() {
            // Setup global toast container if not exists
            if (!document.getElementById('drastic-toast-container')) {
                const toastContainer = document.createElement('div');
                toastContainer.id = 'drastic-toast-container';
                toastContainer.className = 'fixed top-6 right-6 z-50 flex flex-col gap-4';
                document.body.appendChild(toastContainer);
            }

            const wsUrl = `ws://${window.location.hostname}:3000/ws`;
            const ws = new WebSocket(wsUrl);

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.channel === 'drastic_event') {
                        const data = msg.data;

                        // 1. Prepend to Live Insights (News Intelligence Module)
                        const insightsContainer = document.querySelector('.overflow-y-auto.p-4.space-y-4');
                        if (insightsContainer) {
                            const alertHtml = `
                                <div class="glass-panel p-4 rounded-xl border-l-4 border-l-red-500 animate-pulse bg-red-500/10">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <div class="size-6 rounded-full bg-red-500/20 flex items-center justify-center">
                                                <span class="material-symbols-outlined text-red-500 text-xs">warning</span>
                                            </div>
                                            <span class="text-xs font-bold text-red-500 uppercase tracking-wider">${data.level} ALERT</span>
                                        </div>
                                        <span class="text-[10px] text-red-400 font-mono">JUST NOW</span>
                                    </div>
                                    <p class="text-xs text-white font-semibold leading-relaxed mb-2">${data.headline}</p>
                                    <div class="flex items-center gap-2 text-[10px] text-slate-400">
                                        <span class="px-2 py-0.5 rounded-full bg-slate-800 text-slate-300">${data.asset}</span>
                                        <span class="px-2 py-0.5 rounded-full ${data.impact === 'BULLISH' ? 'bg-primary/20 text-primary' : 'bg-red-500/20 text-red-400'}">${data.impact}</span>
                                    </div>
                                </div>
                            `;
                            insightsContainer.insertAdjacentHTML('afterbegin', alertHtml);
                        }

                        // 2. Show floating global toast
                        const toastMsg = document.createElement('div');
                        toastMsg.className = 'glass-panel p-4 rounded-xl border border-red-500/50 shadow-2xl flex flex-col gap-2 w-80 transform transition-all duration-500 translate-x-10 opacity-0';
                        toastMsg.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(0,0,0,0.8) 100%)';
                        toastMsg.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-red-500 animate-bounce">campaign</span>
                                <h4 class="text-sm font-bold text-red-500">Drastic Event Detected</h4>
                            </div>
                            <p class="text-xs text-slate-200">${data.headline}</p>
                        `;
                        document.getElementById('drastic-toast-container').appendChild(toastMsg);

                        // Animate in
                        setTimeout(() => {
                            toastMsg.classList.remove('translate-x-10', 'opacity-0');
                        }, 50);

                        // Remove tooltip after 8s
                        setTimeout(() => {
                            toastMsg.classList.add('opacity-0', 'translate-x-10');
                            setTimeout(() => toastMsg.remove(), 500);
                        }, 8000);
                    }
                } catch (e) {
                    // Ignore parse errors
                }
            };
        }

        loadLiveTrading();

        let currentDirection = 'BULLISH';
        function selectDirection(dir) {
            currentDirection = dir;
            const bullBtn = document.getElementById('dir-bullish');
            const bearBtn = document.getElementById('dir-bearish');
            if (dir === 'BULLISH') {
                bullBtn.className = 'flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-primary bg-primary/10 text-primary transition-all';
                bearBtn.className = 'flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-slate-700 hover:border-red-500/50 hover:bg-red-500/10 transition-all text-slate-400 hover:text-red-500';
            } else {
                bearBtn.className = 'flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-red-500 bg-red-500/10 text-red-500 transition-all';
                bullBtn.className = 'flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-slate-700 hover:border-primary/50 hover:bg-primary/10 transition-all text-slate-400 hover:text-primary';
            }
        }

        // Make Live Arena actually Live by periodically checking for new predictions
        setInterval(async () => {
            // Only update if not currently loading
            if (!document.getElementById('submit-prediction-btn').disabled) {
                await loadLiveTrading();

                // Add fluctuating data processing bar visual to show it's "Live"
                const processingBar = document.querySelector('.bg-primary.ai-glow');
                if (processingBar) {
                    const pct = 70 + Math.random() * 29;
                    processingBar.style.width = pct.toFixed(1) + '%';
                    const diffEl = processingBar.parentElement.previousElementSibling.querySelector('.text-primary.font-mono');
                    if (diffEl) {
                        diffEl.textContent = pct.toFixed(1) + '%';
                    }
                }
            }
        }, 5000);

        async function submitPrediction() {
            const size = document.getElementById('position-slider').value;
            const btn = document.getElementById('submit-prediction-btn');

            btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-background-dark">refresh</span>';
            btn.disabled = true;

            const req = await apiPost('/trading/predictions', {
                symbol: selectedSymbol,
                direction: currentDirection,
                position_size: Number(size),
                timeframe: '24h'
            });

            btn.textContent = 'SUBMIT PREDICTION';
            btn.disabled = false;

            if (req && !req.error) {
                // Update Personal Section
                const isBullish = currentDirection === 'BULLISH';

                const userPredText = document.getElementById('user-pred-text');
                // Mock a predicted change based on AI comparison locally for the visual demo
                const simulatedChange = (Math.random() * 5 + 1).toFixed(1);
                userPredText.textContent = `${currentDirection} ${isBullish ? '+' : '-'}${simulatedChange}%`;
                userPredText.className = `text-lg font-bold ${isBullish ? 'text-primary' : 'text-red-500'}`;

                const quoteText = document.getElementById('main-price-display').textContent.replace('$', '').replace(/,/g, '');
                const currentPrice = Number(quoteText) || (selectedSymbol === 'BTC' ? 64000 : 800);
                const posTargetRaw = isBullish ? currentPrice * (1 + (simulatedChange / 100)) : currentPrice * (1 - (simulatedChange / 100));

                const userPredTarget = document.getElementById('user-pred-target');
                userPredTarget.textContent = 'Target: $' + posTargetRaw.toLocaleString('en-US', { minimumFractionDigits: 2 });
                userPredTarget.className = `text-xs ${isBullish ? 'text-primary/70' : 'text-red-500/70'}`;

                const userPredIcon = document.getElementById('user-pred-icon');
                userPredIcon.textContent = isBullish ? 'trending_up' : 'trending_down';
                userPredIcon.className = `material-symbols-outlined text-3xl ${isBullish ? 'text-primary' : 'text-red-500'}`;

                const userPredBar = document.getElementById('user-pred-bar');
                userPredBar.style.width = '100%';
                userPredBar.className = `h-full ${isBullish ? 'bg-primary' : 'bg-red-500'}`;

                // Show a mini success notification
                const toastContainer = document.getElementById('drastic-toast-container');
                if (toastContainer) {
                    const toastMsg = document.createElement('div');
                    toastMsg.className = 'glass-panel p-4 rounded-xl border border-primary/50 shadow-2xl flex flex-col gap-2 w-80 transform transition-all duration-500 translate-x-10 opacity-0 bg-primary/10';
                    toastMsg.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">check_circle</span>
                            <h4 class="text-sm font-bold text-primary">Prediction Dispatched</h4>
                        </div>
                        <p class="text-xs text-slate-200">Successfully locked in ${currentDirection} order on ${selectedSymbol}</p>
                    `;
                    toastContainer.appendChild(toastMsg);
                    setTimeout(() => toastMsg.classList.remove('translate-x-10', 'opacity-0'), 50);
                    setTimeout(() => {
                        toastMsg.classList.add('opacity-0', 'translate-x-10');
                        setTimeout(() => toastMsg.remove(), 500);
                    }, 4000);
                }
            } else {
                alert('Connection to prediction engine failed.');
            }
        }
    </script>
</body>

</html>